name: Django CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  DJANGO_SETTINGS_MODULE: "config.settings"  # –ø—É—Ç—å –∫ settings
  PYTHON_VERSION: '3.12'

jobs:
  # Job –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_habitflow_db
          POSTGRES_USER: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      # Database
      POSTGRES_HOST: localhost
      POSTGRES_PORT: 5432
      POSTGRES_DB: test_habitflow_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/test_habitflow_db

      # Redis
      REDIS_HOST: localhost
      REDIS_PORT: 6379
      REDIS_URL: redis://localhost:6379/0

      # Django
      DEBUG: "True"
      SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY || 'test-secret-key-for-ci-${{ github.run_id }}' }}
      ALLOWED_HOSTS: "localhost,127.0.0.1"

      # Security
      CSRF_TRUSTED_ORIGINS: "http://localhost"
      SECURE_SSL_REDIRECT: "False"

    steps:
    - name: Check out code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        cache-dependency-path: '**/requirements*.txt'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libpq-dev gcc

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        # –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        pip install black flake8 isort

    - name: Wait for services to be ready
      run: |
        echo "‚è≥ Waiting for PostgreSQL..."
        for i in {1..10}; do
          if pg_isready -h localhost -p 5432; then
            echo "‚úÖ PostgreSQL is ready!"
            break
          fi
          echo "Attempt $i/10..."
          sleep 3
        done
        
        echo "‚è≥ Waiting for Redis..."
        for i in {1..10}; do
          if redis-cli -h localhost -p 6379 ping | grep -q PONG; then
            echo "‚úÖ Redis is ready!"
            break
          fi
          echo "Attempt $i/10..."
          sleep 2
        done

    - name: Run database migrations
      run: |
        python manage.py makemigrations --check --dry-run
        python manage.py migrate --noinput

    - name: Run code quality checks (optional)
      run: |
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å Black
        black --check --diff . || echo "‚ö†Ô∏è Black check failed (run 'black .' to fix)"
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–ª—è —Å Flake8
        flake8 . --count --max-complexity=10 --max-line-length=88 --statistics || echo "‚ö†Ô∏è Flake8 found issues"
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–ø–æ—Ä—Ç–æ–≤ —Å isort
        isort --check-only --diff . || echo "‚ö†Ô∏è Import sorting needed (run 'isort .')"

    - name: Run Django tests
      run: |
        python manage.py test --verbosity=2 --noinput --parallel

    - name: Check for migrations
      run: |
        python manage.py makemigrations --check --dry-run
        if [ $? -eq 0 ]; then
          echo "‚úÖ No new migrations needed"
        else
          echo "‚ùå New migrations detected! Run 'python manage.py makemigrations'"
          exit 1
        fi

    - name: Collect static files (test)
      run: |
        python manage.py collectstatic --noinput --clear
        echo "‚úÖ Static files collected"

  # Job –¥–ª—è –¥–µ–ø–ª–æ—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
  deploy:
    runs-on: ubuntu-latest
    needs: test  # –ó–∞–ø—É—Å–∫–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
    if: github.ref == 'refs/heads/main'  # –¢–æ–ª—å–∫–æ –¥–ª—è main –≤–µ—Ç–∫–∏

    steps:
    - name: Check out code
      uses: actions/checkout@v4

    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Add server to known hosts
      run: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
        chmod 600 ~/.ssh/known_hosts
        echo "‚úÖ Added server to known_hosts"

    - name: Test SSH connection
      run: |
        echo "Testing SSH connection to ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }}..."
        ssh -o ConnectTimeout=10 -o BatchMode=yes ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} "echo '‚úÖ SSH connection successful!'; whoami; pwd"

    - name: Prepare deployment script
      run: |
        cat > deploy.sh << 'EOF'
        #!/bin/bash
        set -e  # Exit on error
        
        echo "=== üöÄ Starting deployment at $(date) ==="
        
        # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
        cd ${{ secrets.DEPLOY_DIR }}
        echo "üìÅ Working directory: $(pwd)"
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
        echo "üì• Pulling latest code..."
        git fetch origin
        git reset --hard origin/main
        
        # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
        echo "üêç Activating virtual environment..."
        if [ -f "venv/bin/activate" ]; then
            source venv/bin/activate
        else
            echo "‚ùå Virtual environment not found!"
            exit 1
        fi
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        echo "üì¶ Installing/updating dependencies..."
        pip install --upgrade pip
        pip install -r requirements.txt
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏
        echo "üîÑ Running migrations..."
        python manage.py migrate --noinput
        
        # –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏–∫—É
        echo "üìÅ Collecting static files..."
        python manage.py collectstatic --noinput --clear
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–∞–≤–∫–∏ –∫ —Å—Ç–∞—Ç–∏–∫–µ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
        echo "üîß Applying static file fixes..."
        python manage.py compress --force
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Django
        echo "üîç Checking Django configuration..."
        python manage.py check --deploy
        
        # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã
        echo "üîÑ Restarting services..."
        
        # Gunicorn (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
        if systemctl list-unit-files | grep -q gunicorn; then
            sudo systemctl restart gunicorn
            echo "‚úÖ Gunicorn restarted"
        fi
        
        # Nginx
        sudo systemctl reload nginx
        echo "‚úÖ Nginx reloaded"
        
        # Celery (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
        if systemctl list-unit-files | grep -q celery; then
            sudo systemctl restart celery
            sudo systemctl restart celerybeat
            echo "‚úÖ Celery services restarted"
        fi
        
        # –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞
        echo "üßπ Clearing cache..."
        python manage.py clear_cache
        redis-cli FLUSHALL 2>/dev/null || echo "‚ö†Ô∏è Redis not available for cache clearing"
        
        echo "=== ‚úÖ Deployment completed successfully at $(date) ==="
        
        # –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤
        echo "üìä Service status:"
        sudo systemctl status gunicorn nginx --no-pager | grep -E "(Active|Status)" || true
        EOF
        
        chmod +x deploy.sh

    - name: Deploy to production server
      run: |
        echo "üöÄ Deploying to ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }}..."
        scp -o StrictHostKeyChecking=no deploy.sh ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }}:/tmp/deploy.sh
        ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} "bash /tmp/deploy.sh"

    - name: Verify deployment
      run: |
        echo "üîç Verifying deployment..."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤
        ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
          echo "=== Service Status ==="
          sudo systemctl status gunicorn --no-pager | head -10 || echo "‚ö†Ô∏è Gunicorn service not found"
          sudo systemctl status nginx --no-pager | head -10 || echo "‚ö†Ô∏è Nginx service not found"
          
          echo "=== Application Health Check ==="
          # –ü–æ–¥–æ–∂–¥–∏ –Ω–µ–º–Ω–æ–≥–æ –ø–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ—Ä–∫–æ–π
          sleep 5
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/ || echo "curl failed")
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "302" ]; then
            echo "‚úÖ Application is responding (HTTP $HTTP_CODE)"
          else
            echo "‚ö†Ô∏è Application check returned HTTP $HTTP_CODE"
          fi
        EOF

    - name: Cleanup
      run: |
        rm -f deploy.sh
        echo "‚úÖ Cleanup completed"

  # Job –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  notify:
    runs-on: ubuntu-latest
    needs: [test, deploy]
    if: always()  # –í—Å–µ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞–µ–º, –¥–∞–∂–µ –µ—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ jobs —É–ø–∞–ª–∏

    steps:
    - name: Deployment status
      run: |
        echo "Deployment Summary:"
        echo "Repository: ${{ github.repository }}"
        echo "Branch: ${{ github.ref }}"
        echo "Commit: ${{ github.sha }}"
        echo "Author: ${{ github.actor }}"
        echo "Run URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        
        # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Slack/Telegram/Email
        if [ "${{ job.status }}" = "success" ]; then
          echo "‚úÖ All jobs completed successfully!"
        else
          echo "‚ùå Some jobs failed. Check the workflow run for details."
        fi